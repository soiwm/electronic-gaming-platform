-- 电子游戏平台数据库建表脚本
-- 数据库用户：system
-- 密码：orcl

-- 注意：执行顺序很重要，先创建基础表，再创建有关联关系的表

-- 1. 创建游戏表(GAMES)
CREATE TABLE GAMES (
    ID NUMBER(10) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    TYPE VARCHAR2(50) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    PRICE NUMBER(10,2) NOT NULL,
    LOGO VARCHAR2(200),
    CREATE_TIME TIMESTAMP DEFAULT SYSDATE,
    UPDATE_TIME TIMESTAMP DEFAULT SYSDATE,
    CONSTRAINT UK_GAMES_NAME UNIQUE (NAME)  -- 游戏名称唯一约束，防止重复添加
);

-- 2. 创建客户表(CUSTOMERS)
CREATE TABLE CUSTOMERS (
    ID NUMBER(10) PRIMARY KEY,
    NAME VARCHAR2(50) NOT NULL,
    GENDER VARCHAR2(10) NOT NULL,
    PHONE VARCHAR2(20) NOT NULL,
    ADDRESS VARCHAR2(200) NOT NULL,
    EMAIL VARCHAR2(100),
    BIRTH_DATE DATE,
    CREATE_TIME TIMESTAMP DEFAULT SYSDATE,
    UPDATE_TIME TIMESTAMP DEFAULT SYSDATE,
    CONSTRAINT UK_CUSTOMERS_PHONE UNIQUE (PHONE)  -- 手机号唯一约束，防止重复注册
);

-- 3. 创建订单表(ORDERS)
CREATE TABLE ORDERS (
    ID NUMBER(10) PRIMARY KEY,
    CUSTOMER_ID NUMBER(10) NOT NULL,
    GAME_ID NUMBER(10) NOT NULL,
    AMOUNT NUMBER(10,2) NOT NULL,
    CREATE_TIME TIMESTAMP DEFAULT SYSDATE,
    UPDATE_TIME TIMESTAMP DEFAULT SYSDATE,
    CONSTRAINT FK_ORDERS_CUSTOMER FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(ID),
    CONSTRAINT FK_ORDERS_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMES(ID)
);

-- 4. 创建用户游戏库表(USER_GAME_LIBRARY)
CREATE TABLE USER_GAME_LIBRARY (
    ID NUMBER(10) PRIMARY KEY,
    USER_ID NUMBER(10) NOT NULL,
    USER_NAME VARCHAR2(50) NOT NULL,
    GAME_ID NUMBER(10) NOT NULL,
    IS_INSTALLED NUMBER(1) DEFAULT 0,  -- 是否安装：0-未安装，1-已安装
    IS_FAVORITE NUMBER(1) DEFAULT 0,   -- 是否收藏：0-未收藏，1-已收藏
    PURCHASE_TIME TIMESTAMP DEFAULT SYSDATE,
    CREATE_TIME TIMESTAMP DEFAULT SYSDATE,
    UPDATE_TIME TIMESTAMP DEFAULT SYSDATE,
    CONSTRAINT FK_USER_GAME_LIBRARY_USER FOREIGN KEY (USER_ID) REFERENCES CUSTOMERS(ID),
    CONSTRAINT FK_USER_GAME_LIBRARY_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMES(ID),
    CONSTRAINT UK_USER_GAME_LIBRARY_USER_GAME UNIQUE (USER_ID, GAME_ID)  -- 确保同一用户不会重复购买同一游戏
);

-- 创建序列
-- 游戏ID序列
CREATE SEQUENCE GAMES_SEQ
    INCREMENT BY 1
    START WITH 1
    NOMAXVALUE
    NOMINVALUE
    NOCYCLE
    NOCACHE;

-- 客户ID序列
CREATE SEQUENCE CUSTOMERS_SEQ
    INCREMENT BY 1
    START WITH 1
    NOMAXVALUE
    NOMINVALUE
    NOCYCLE
    NOCACHE;

-- 订单ID序列
CREATE SEQUENCE ORDERS_SEQ
    INCREMENT BY 1
    START WITH 1
    NOMAXVALUE
    NOMINVALUE
    NOCYCLE
    NOCACHE;

-- 用户游戏库ID序列
CREATE SEQUENCE USER_GAME_LIBRARY_SEQ
    INCREMENT BY 1
    START WITH 1
    NOMAXVALUE
    NOMINVALUE
    NOCYCLE
    NOCACHE;

-- 创建触发器
-- 游戏ID自增触发器
CREATE OR REPLACE TRIGGER GAMES_TRG
BEFORE INSERT ON GAMES
FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := GAMES_SEQ.NEXTVAL;
    END IF;
    :NEW.CREATE_TIME := SYSDATE;
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 游戏更新时间触发器
CREATE OR REPLACE TRIGGER GAMES_UPDATE_TRG
BEFORE UPDATE ON GAMES
FOR EACH ROW
BEGIN
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 客户ID自增触发器
CREATE OR REPLACE TRIGGER CUSTOMERS_TRG
BEFORE INSERT ON CUSTOMERS
FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := CUSTOMERS_SEQ.NEXTVAL;
    END IF;
    :NEW.CREATE_TIME := SYSDATE;
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 客户更新时间触发器
CREATE OR REPLACE TRIGGER CUSTOMERS_UPDATE_TRG
BEFORE UPDATE ON CUSTOMERS
FOR EACH ROW
BEGIN
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 订单ID自增触发器
CREATE OR REPLACE TRIGGER ORDERS_TRG
BEFORE INSERT ON ORDERS
FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := ORDERS_SEQ.NEXTVAL;
    END IF;
    :NEW.CREATE_TIME := SYSDATE;
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 订单更新时间触发器
CREATE OR REPLACE TRIGGER ORDERS_UPDATE_TRG
BEFORE UPDATE ON ORDERS
FOR EACH ROW
BEGIN
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 用户游戏库ID自增触发器
CREATE OR REPLACE TRIGGER USER_GAME_LIBRARY_TRG
BEFORE INSERT ON USER_GAME_LIBRARY
FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := USER_GAME_LIBRARY_SEQ.NEXTVAL;
    END IF;
    :NEW.CREATE_TIME := SYSDATE;
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 用户游戏库更新时间触发器
CREATE OR REPLACE TRIGGER USER_GAME_LIBRARY_UPDATE_TRG
BEFORE UPDATE ON USER_GAME_LIBRARY
FOR EACH ROW
BEGIN
    :NEW.UPDATE_TIME := SYSDATE;
END;
/

-- 插入测试数据
-- 插入游戏数据
INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (1, '英雄联盟', 'MOBA', '一款由Riot Games开发的多人在线战术竞技游戏', 198.00, '/images/game/lol.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (2, '绝地求生', '射击', '一款由Bluehole开发的战术竞技类射击沙盒游戏', 298.00, '/images/game/pubg.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (3, '魔兽世界', '角色扮演', '一款由Blizzard Entertainment开发的大型多人在线角色扮演游戏', 199.00, '/images/game/wow.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (4, '文明6', '策略', '一款由Firaxis Games开发的回合制策略游戏', 199.00, '/images/game/civ6.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (5, '守望先锋', '射击', '一款由Blizzard Entertainment开发的团队-based多人第一人称射击游戏', 198.00, '/images/game/overwatch.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (6, '炉石传说', '卡牌', '一款由Blizzard Entertainment开发的免费在线卡牌收集游戏', 0.00, '/images/game/hearthstone.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (7, 'Dota 2', 'MOBA', '一款由Valve Corporation开发的多人在线战术竞技游戏', 0.00, '/images/game/dota2.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (8, 'CS:GO', '射击', '一款由Valve和Hidden Path Entertainment开发的第一人称射击游戏', 0.00, '/images/game/csgo.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (9, '古墓丽影：暗影', '动作冒险', '一款由Eidos Montreal开发的动作冒险游戏', 298.00, '/images/game/tombraider.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (10, 'FIFA 23', '体育', '一款由EA Vancouver开发的足球模拟游戏', 398.00, '/images/game/fifa23.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (11, '荒野大镖客：救赎2', '动作冒险', '一款由Rockstar Games开发的动作冒险游戏', 398.00, '/images/game/rdr2.jpg');

INSERT INTO GAMES (ID, NAME, TYPE, DESCRIPTION, PRICE, LOGO) 
VALUES (12, '刺客信条：英灵殿', '动作冒险', '一款由Ubisoft Montreal开发的动作冒险游戏', 398.00, '/images/game/acvalhalla.jpg');

-- 插入客户数据
INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (1, '张三', '1', '13800138001', '北京市朝阳区', 'zhangsan@example.com', TO_DATE('1990-05-15', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (2, '李四', '2', '13800138002', '上海市浦东新区', 'lisi@example.com', TO_DATE('1985-08-20', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (3, '王五', '1', '13800138003', '广州市天河区', 'wangwu@example.com', TO_DATE('1995-03-10', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (4, '赵六', '2', '13800138004', '深圳市南山区', 'zhaoliu@example.com', TO_DATE('1988-12-25', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (5, '钱七', '1', '13800138005', '杭州市西湖区', 'qianqi@example.com', TO_DATE('1992-07-08', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (6, '孙八', '2', '13800138006', '成都市高新区', 'sunba@example.com', TO_DATE('1987-11-30', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (7, '周九', '1', '13800138007', '武汉市洪山区', 'zhoujiu@example.com', TO_DATE('1993-06-18', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (8, '吴十', '2', '13800138008', '南京市江宁区', 'wushi@example.com', TO_DATE('1991-09-22', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (9, '郑十一', '1', '13800138009', '西安市雁塔区', 'zhengshiyi@example.com', TO_DATE('1989-04-05', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (10, '王小明', '1', '13800138010', '重庆市渝北区', 'wangxiaoming@example.com', TO_DATE('1994-02-14', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (11, '陈小红', '2', '13800138011', '天津市滨海新区', 'chenxiaohong@example.com', TO_DATE('1996-10-28', 'YYYY-MM-DD'));

INSERT INTO CUSTOMERS (ID, NAME, GENDER, PHONE, ADDRESS, EMAIL, BIRTH_DATE) 
VALUES (12, '刘小强', '1', '13800138012', '苏州市工业园区', 'liuxiaoqiang@example.com', TO_DATE('1990-07-19', 'YYYY-MM-DD'));

-- 插入订单数据
INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (1, 1, 1, 198.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (2, 2, 2, 298.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (3, 3, 3, 398.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (4, 1, 4, 199.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (5, 2, 1, 198.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (6, 4, 5, 198.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (7, 5, 6, 0.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (8, 6, 7, 0.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (9, 7, 8, 0.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (10, 8, 9, 298.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (11, 9, 10, 398.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (12, 10, 11, 398.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (13, 11, 12, 398.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (14, 12, 3, 199.00);

INSERT INTO ORDERS (ID, CUSTOMER_ID, GAME_ID, AMOUNT) 
VALUES (15, 1, 6, 0.00);

-- 插入用户游戏库数据
INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (1, 1, '张三', 1, 1, 1, TO_DATE('2023-01-15', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (2, 1, '张三', 2, 1, 0, TO_DATE('2023-02-20', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (3, 2, '李四', 1, 1, 1, TO_DATE('2023-01-25', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (4, 2, '李四', 3, 1, 0, TO_DATE('2023-03-10', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (5, 3, '王五', 4, 1, 1, TO_DATE('2023-02-15', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (6, 3, '王五', 5, 1, 0, TO_DATE('2023-04-05', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (7, 4, '赵六', 6, 1, 1, TO_DATE('2023-03-20', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (8, 4, '赵六', 7, 1, 0, TO_DATE('2023-05-12', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (9, 5, '钱七', 8, 1, 1, TO_DATE('2023-04-18', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (10, 5, '钱七', 9, 1, 0, TO_DATE('2023-06-01', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (11, 6, '孙八', 10, 1, 1, TO_DATE('2023-05-25', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (12, 6, '孙八', 11, 1, 0, TO_DATE('2023-07-10', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (13, 7, '周九', 12, 1, 1, TO_DATE('2023-06-15', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (14, 8, '吴十', 1, 1, 0, TO_DATE('2023-07-20', 'YYYY-MM-DD'));

INSERT INTO USER_GAME_LIBRARY (ID, USER_ID, USER_NAME, GAME_ID, IS_INSTALLED, IS_FAVORITE, PURCHASE_TIME) 
VALUES (15, 8, '吴十', 2, 1, 1, TO_DATE('2023-08-05', 'YYYY-MM-DD'));

-- 提交事务
COMMIT;

-- 查看表结构
DESC GAMES;
DESC CUSTOMERS;
DESC ORDERS;
DESC USER_GAME_LIBRARY;

-- 查看约束信息
SELECT TABLE_NAME, CONSTRAINT_NAME, CONSTRAINT_TYPE 
FROM USER_CONSTRAINTS 
WHERE TABLE_NAME IN ('GAMES', 'CUSTOMERS', 'ORDERS', 'USER_GAME_LIBRARY')
ORDER BY TABLE_NAME, CONSTRAINT_NAME;

-- 查看示例数据
SELECT '游戏数据' AS 表名, COUNT(*) AS 记录数 FROM GAMES
UNION ALL
SELECT '客户数据' AS 表名, COUNT(*) AS 记录数 FROM CUSTOMERS
UNION ALL
SELECT '订单数据' AS 表名, COUNT(*) AS 记录数 FROM ORDERS
UNION ALL
SELECT '用户游戏库数据' AS 表名, COUNT(*) AS 记录数 FROM USER_GAME_LIBRARY;